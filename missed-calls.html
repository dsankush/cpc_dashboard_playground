<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Missed Call Data Dashboard ‚Äî Coromandel CPC</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800;900&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <style>
    :root{
      --bg:#f8fafc;
      --panel:#ffffff;
      --card:#ffffff;
      --card-hover:#f8f9ff;
      --text:#1f2937;
      --muted:#6b7280;
      --acc1:#6366f1;
      --acc2:#f59e0b;
      --acc3:#10b981;
      --acc4:#ec4899;
      --acc5:#8b5cf6;
      --ring:#e5e7eb;
      --border:#d1d5db;
      --shadow:rgba(99,102,241,.08);
      --shadow-lg:rgba(99,102,241,.15);
      --danger:#ef4444;
      --success:#10b981;
      --warning:#f59e0b;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;overflow-x:hidden}
    body{
      font-family:'Outfit',sans-serif;
      background:var(--bg);
      color:var(--text);
      min-height:100vh;
    }
    
    /* Loading Overlay */
    .loading-overlay{
      position:fixed;
      top:0;left:0;right:0;bottom:0;
      background:rgba(255,255,255,0.95);
      backdrop-filter:blur(10px);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      z-index:9999;
      transition:opacity 0.3s, visibility 0.3s;
    }
    .loading-overlay.hidden{
      opacity:0;
      visibility:hidden;
    }
    .spinner{
      width:60px;
      height:60px;
      border:4px solid #e5e7eb;
      border-top-color:var(--acc1);
      border-radius:50%;
      animation:spin 1s linear infinite;
    }
    @keyframes spin{
      to{transform:rotate(360deg)}
    }
    .loading-text{
      margin-top:20px;
      font-size:1.125rem;
      font-weight:600;
      color:var(--acc1);
      animation:pulse 1.5s ease-in-out infinite;
    }
    
    /* Error Alert */
    .alert{
      background:linear-gradient(135deg, rgba(239,68,68,0.1), rgba(239,68,68,0.05));
      border:2px solid var(--danger);
      border-radius:16px;
      padding:24px 32px;
      margin:20px auto;
      max-width:800px;
      display:none;
      animation:slideDown 0.3s ease-out;
    }
    @keyframes slideDown{
      from{transform:translateY(-20px);opacity:0}
      to{transform:translateY(0);opacity:1}
    }
    .alert.show{display:block}
    .alert-header{
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom:12px;
    }
    .alert-icon{
      font-size:24px;
    }
    .alert-title{
      font-size:1.25rem;
      font-weight:800;
      color:var(--danger);
    }
    .alert-body{
      color:var(--text);
      line-height:1.6;
      margin-bottom:16px;
    }
    .alert-actions{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
    }
    
    /* File Upload Area */
    .upload-area{
      background:linear-gradient(135deg, rgba(99,102,241,0.05), rgba(16,185,129,0.05));
      border:3px dashed var(--acc1);
      border-radius:20px;
      padding:48px 32px;
      text-align:center;
      margin:20px auto;
      max-width:600px;
      cursor:pointer;
      transition:all 0.3s cubic-bezier(0.4,0,0.2,1);
      display:none;
    }
    .upload-area.show{display:block}
    .upload-area:hover{
      background:linear-gradient(135deg, rgba(99,102,241,0.1), rgba(16,185,129,0.1));
      border-color:var(--acc3);
      transform:translateY(-4px);
      box-shadow:0 8px 32px rgba(99,102,241,0.2);
    }
    .upload-icon{
      font-size:64px;
      margin-bottom:16px;
    }
    .upload-title{
      font-size:1.5rem;
      font-weight:800;
      margin-bottom:8px;
      background:linear-gradient(135deg,var(--acc1),var(--acc3));
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
    }
    .upload-text{
      color:var(--muted);
      font-size:14px;
      margin-bottom:16px;
    }
    #csvFileInput{
      display:none;
    }
    
    /* Header */
    header{
      background:rgba(255,255,255,.98);
      border-bottom:2px solid var(--ring);
      box-shadow:0 4px 16px var(--shadow);
      position:sticky;
      top:0;
      z-index:100;
      backdrop-filter:blur(20px);
    }
    .bar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:20px 40px;
      flex-wrap:wrap;
      gap:20px;
    }
    .logo{
      display:flex;
      align-items:center;
      gap:12px;
    }
    .dot{
      width:16px;
      height:16px;
      border-radius:50%;
      background:linear-gradient(135deg,var(--acc1),var(--acc3));
      box-shadow:0 4px 12px rgba(99,102,241,0.4);
      animation:pulse 2s infinite;
    }
    @keyframes pulse{
      0%, 100%{transform:scale(1);opacity:1}
      50%{transform:scale(1.15);opacity:0.8}
    }
    .title{
      font-size:1.5rem;
      font-weight:900;
      font-family:'Space Grotesk',sans-serif;
      background:linear-gradient(135deg,var(--acc1),var(--acc3));
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
    }
    .status-badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 12px;
      background:linear-gradient(135deg, var(--success), #059669);
      color:white;
      border-radius:20px;
      font-size:12px;
      font-weight:700;
      box-shadow:0 2px 8px rgba(16,185,129,0.3);
    }
    .status-badge::before{
      content:'‚óè';
      animation:blink 2s infinite;
    }
    @keyframes blink{
      0%, 100%{opacity:1}
      50%{opacity:0.3}
    }
    
    /* Main */
    .main{
      max-width:1600px;
      margin:0 auto;
      padding:40px;
      display:none;
    }
    .main.show{display:block}
    
    /* KPIs */
    .kpis{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
      gap:24px;
      margin-bottom:40px;
    }
    .kpi{
      background:linear-gradient(135deg, rgba(255,255,255,0.98) 0%, rgba(249,250,251,0.95) 100%);
      backdrop-filter:blur(20px);
      border-radius:20px;
      padding:32px;
      box-shadow:0 8px 32px rgba(0,0,0,0.08), 0 2px 8px rgba(0,0,0,0.04);
      border:2px solid rgba(255,255,255,0.8);
      position:relative;
      overflow:hidden;
      transition:all .3s cubic-bezier(0.4,0,0.2,1);
    }
    .kpi::before{
      content:'';
      position:absolute;
      top:0;left:0;right:0;
      height:4px;
      background:linear-gradient(90deg, var(--acc1), var(--acc3));
      opacity:0;
      transition:opacity .3s ease;
    }
    .kpi:hover{
      transform:translateY(-6px) scale(1.02);
      box-shadow:0 16px 48px rgba(0,0,0,0.12), 0 4px 16px rgba(0,0,0,0.06);
      border-color:var(--acc1);
    }
    .kpi:hover::before{
      opacity:1;
    }
    .kpi-icon{
      font-size:32px;
      margin-bottom:12px;
      display:inline-block;
      filter:grayscale(0.2);
    }
    .kpi-label{
      font-size:13px;
      color:var(--muted);
      font-weight:700;
      margin-bottom:12px;
      text-transform:uppercase;
      letter-spacing:0.5px;
    }
    .kpi-value{
      font-size:2.75rem;
      font-weight:900;
      background:linear-gradient(135deg,var(--acc1),var(--acc3));
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      font-family:'Space Grotesk',sans-serif;
      line-height:1;
    }
    .kpi-subtext{
      font-size:12px;
      color:var(--muted);
      margin-top:8px;
      font-weight:500;
    }
    
    /* Filters */
    .filters-section{
      background:linear-gradient(135deg, rgba(255,255,255,0.98) 0%, rgba(249,250,251,0.95) 100%);
      backdrop-filter:blur(20px);
      border-radius:24px;
      padding:36px 40px;
      box-shadow:0 8px 32px rgba(0,0,0,0.08), 0 2px 8px rgba(0,0,0,0.04), inset 0 1px 0 rgba(255,255,255,0.9);
      border:2px solid rgba(255,255,255,0.8);
      margin-bottom:40px;
      position:relative;
      overflow:hidden;
      transition:all .4s cubic-bezier(0.4,0,0.2,1);
    }
    .filters-section::before{
      content:'';
      position:absolute;
      top:0;left:0;right:0;
      height:3px;
      background:linear-gradient(90deg, #6366f1, #ec4899, #10b981, #f59e0b, #6366f1);
      background-size:200% 100%;
      animation:shimmer 3s linear infinite;
    }
    @keyframes shimmer{
      0%{background-position:200% 0}
      100%{background-position:-200% 0}
    }
    .filters-section:hover{
      box-shadow:0 12px 48px rgba(0,0,0,0.12), 0 4px 16px rgba(0,0,0,0.06);
      transform:translateY(-2px);
    }
    .filters-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:32px;
      flex-wrap:wrap;
      gap:16px;
    }
    .filters-title{
      font-size:1.5rem;
      font-weight:800;
      font-family:'Space Grotesk',sans-serif;
      background:linear-gradient(135deg,var(--acc1),var(--acc3));
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      display:flex;
      align-items:center;
      gap:12px;
    }
    .filters-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:24px;
      margin-bottom:32px;
    }
    .filter-group{
      display:flex;
      flex-direction:column;
      gap:10px;
      position:relative;
    }
    .filter-group label{
      font-size:12px;
      color:#64748b;
      font-weight:800;
      text-transform:uppercase;
      letter-spacing:1px;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .filter-count{
      font-size:10px;
      background:linear-gradient(135deg, var(--acc1), var(--acc3));
      color:white;
      padding:3px 10px;
      border-radius:12px;
      font-weight:700;
      margin-left:8px;
      box-shadow:0 2px 8px rgba(99,102,241,0.3);
    }
    .filter-group input,
    .filter-group select{
      padding:14px 18px;
      border:2px solid #e2e8f0;
      border-radius:12px;
      font-family:'Outfit',sans-serif;
      font-size:14px;
      font-weight:500;
      background:white;
      transition:all .3s cubic-bezier(0.4,0,0.2,1);
      box-shadow:0 2px 8px rgba(0,0,0,0.04);
      cursor:pointer;
    }
    .filter-group input:hover,
    .filter-group select:hover{
      border-color:#cbd5e1;
      box-shadow:0 4px 12px rgba(0,0,0,0.08);
    }
    .filter-group input:focus,
    .filter-group select:focus{
      outline:none;
      border-color:var(--acc1);
      box-shadow:0 0 0 4px rgba(99,102,241,0.12), 0 4px 16px rgba(99,102,241,0.2);
      transform:translateY(-2px);
    }
    .filter-actions{
      display:flex;
      gap:16px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }
    .btn{
      padding:14px 32px;
      border:none;
      border-radius:12px;
      font-family:'Outfit',sans-serif;
      font-size:14px;
      font-weight:700;
      cursor:pointer;
      transition:all .3s cubic-bezier(0.4,0,0.2,1);
      box-shadow:0 4px 12px rgba(0,0,0,0.1);
      position:relative;
      overflow:hidden;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .btn::before{
      content:'';
      position:absolute;
      top:50%;left:50%;
      width:0;height:0;
      border-radius:50%;
      background:rgba(255,255,255,0.3);
      transform:translate(-50%,-50%);
      transition:width .5s, height .5s;
    }
    .btn:hover::before{
      width:300px;
      height:300px;
    }
    .btn:hover{
      transform:translateY(-3px);
      box-shadow:0 8px 24px rgba(0,0,0,0.2);
    }
    .btn:active{
      transform:translateY(-1px);
    }
    .btn-primary{
      background:linear-gradient(135deg, var(--acc1), var(--acc5));
      color:white;
    }
    .btn-secondary{
      background:linear-gradient(135deg, #64748b, #475569);
      color:white;
    }
    .btn-success{
      background:linear-gradient(135deg, var(--acc3), #059669);
      color:white;
    }
    
    /* Search */
    .search-section{
      background:linear-gradient(135deg, rgba(255,255,255,0.98) 0%, rgba(249,250,251,0.95) 100%);
      backdrop-filter:blur(20px);
      border-radius:20px;
      padding:28px 32px;
      box-shadow:0 8px 32px rgba(0,0,0,0.08), 0 2px 8px rgba(0,0,0,0.04);
      border:2px solid rgba(255,255,255,0.8);
      margin-bottom:40px;
      transition:all .3s cubic-bezier(0.4,0,0.2,1);
    }
    .search-section:hover{
      transform:translateY(-2px);
      box-shadow:0 12px 48px rgba(0,0,0,0.12), 0 4px 16px rgba(0,0,0,0.06);
      border-color:var(--acc1);
    }
    .search-box{
      display:flex;
      gap:16px;
      align-items:center;
      position:relative;
    }
    .search-icon{
      position:absolute;
      left:20px;
      font-size:20px;
      color:var(--muted);
      pointer-events:none;
    }
    .search-input{
      flex:1;
      padding:14px 20px 14px 50px;
      border:2px solid #e2e8f0;
      border-radius:12px;
      font-family:'Outfit',sans-serif;
      font-size:14px;
      font-weight:500;
      background:white;
      box-shadow:0 2px 8px rgba(0,0,0,0.04);
      transition:all .3s cubic-bezier(0.4,0,0.2,1);
    }
    .search-input:focus{
      outline:none;
      border-color:var(--acc1);
      box-shadow:0 0 0 4px rgba(99,102,241,0.12), 0 4px 16px rgba(99,102,241,0.2);
      transform:translateY(-2px);
    }
    .search-count{
      font-size:14px;
      color:var(--muted);
      font-weight:600;
      white-space:nowrap;
    }
    
    /* Charts */
    .charts-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(520px,1fr));
      gap:32px;
      margin-bottom:40px;
    }
    .chart-card{
      background:linear-gradient(135deg, rgba(255,255,255,0.98) 0%, rgba(249,250,251,0.95) 100%);
      backdrop-filter:blur(20px);
      border-radius:20px;
      padding:32px;
      box-shadow:0 8px 32px rgba(0,0,0,0.08), 0 2px 8px rgba(0,0,0,0.04);
      border:2px solid rgba(255,255,255,0.8);
      position:relative;
      overflow:hidden;
      transition:all .3s cubic-bezier(0.4,0,0.2,1);
    }
    .chart-card::before{
      content:'';
      position:absolute;
      top:0;left:0;right:0;
      height:3px;
      background:linear-gradient(90deg, var(--acc1), var(--acc3));
      opacity:0;
      transition:opacity .3s ease;
    }
    .chart-card:hover{
      transform:translateY(-4px);
      box-shadow:0 12px 48px rgba(0,0,0,0.12), 0 4px 16px rgba(0,0,0,0.06);
      border-color:var(--acc1);
    }
    .chart-card:hover::before{
      opacity:1;
    }
    .chart-title{
      font-size:1.125rem;
      font-weight:800;
      font-family:'Space Grotesk',sans-serif;
      background:linear-gradient(135deg,var(--acc1),var(--acc3));
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      margin-bottom:24px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .chart-container{
      position:relative;
      height:320px;
    }
    
    /* Table */
    .table-section{
      background:linear-gradient(135deg, rgba(255,255,255,0.98) 0%, rgba(249,250,251,0.95) 100%);
      backdrop-filter:blur(20px);
      border-radius:20px;
      padding:32px;
      box-shadow:0 8px 32px rgba(0,0,0,0.08), 0 2px 8px rgba(0,0,0,0.04);
      border:2px solid rgba(255,255,255,0.8);
      margin-bottom:40px;
      overflow:hidden;
      transition:all .3s cubic-bezier(0.4,0,0.2,1);
    }
    .table-section:hover{
      box-shadow:0 12px 48px rgba(0,0,0,0.12), 0 4px 16px rgba(0,0,0,0.06);
    }
    .table-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:24px;
      flex-wrap:wrap;
      gap:16px;
    }
    .table-title{
      font-size:1.25rem;
      font-weight:800;
      font-family:'Space Grotesk',sans-serif;
      background:linear-gradient(135deg,var(--acc1),var(--acc3));
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
    }
    .table-info{
      font-size:14px;
      color:var(--muted);
      font-weight:600;
    }
    .table-container{
      overflow-x:auto;
      border-radius:12px;
    }
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
    }
    th,td{
      padding:16px 20px;
      text-align:left;
      border-bottom:1px solid #e5e7eb;
    }
    th{
      font-weight:800;
      font-size:12px;
      color:#475569;
      background:linear-gradient(135deg, #f8fafc, #f1f5f9);
      text-transform:uppercase;
      letter-spacing:0.5px;
      position:sticky;
      top:0;
      z-index:10;
      border-bottom:2px solid var(--acc1);
      white-space:nowrap;
    }
    th:first-child{
      border-top-left-radius:12px;
    }
    th:last-child{
      border-top-right-radius:12px;
    }
    td{
      color:var(--text);
      font-weight:500;
      font-size:14px;
    }
    tr:hover td{
      background:var(--card-hover);
    }
    tr:last-child td{
      border-bottom:none;
    }
    
    /* Pagination */
    .pagination{
      display:flex;
      justify-content:center;
      gap:12px;
      flex-wrap:wrap;
      margin-top:32px;
    }
    .page-btn{
      padding:12px 20px;
      border:2px solid #e2e8f0;
      background:white;
      border-radius:10px;
      cursor:pointer;
      font-family:'Outfit',sans-serif;
      font-weight:700;
      font-size:14px;
      transition:all .3s cubic-bezier(0.4,0,0.2,1);
      box-shadow:0 2px 8px rgba(0,0,0,0.04);
      min-width:48px;
      text-align:center;
    }
    .page-btn:hover:not(:disabled){
      background:linear-gradient(135deg, var(--acc1), var(--acc5));
      color:white;
      border-color:var(--acc1);
      transform:translateY(-2px);
      box-shadow:0 4px 16px rgba(99,102,241,0.3);
    }
    .page-btn.active{
      background:linear-gradient(135deg, var(--acc1), var(--acc5));
      color:white;
      border-color:var(--acc1);
      box-shadow:0 4px 16px rgba(99,102,241,0.3);
    }
    .page-btn:disabled{
      opacity:0.4;
      cursor:not-allowed;
    }
    
    @media (max-width: 1024px){
      .charts-grid{grid-template-columns:1fr}
    }
    @media (max-width: 768px){
      .bar{padding:16px 20px}
      .main{padding:20px 16px}
      .kpis{grid-template-columns:1fr;gap:16px}
      .filters-section{padding:24px 20px}
      .filters-grid{grid-template-columns:1fr}
      .charts-grid{grid-template-columns:1fr}
      .table-section{padding:20px 16px}
      .page-btn{padding:10px 16px;font-size:13px}
      .kpi-value{font-size:2.25rem}
    }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <div class="loading-text">Loading Data...</div>
  </div>

  <header>
    <div class="bar">
      <div class="logo">
        <span class="dot"></span>
        <h1 class="title">Missed Call Analytics</h1>
      </div>
      <nav class="nav-links">
        <a href="index.html" class="nav-link">üìä Dashboard</a>
        <a href="missed-calls.html" class="nav-link active">üìû Missed Call Data</a>
      </nav>
      <span class="status-badge" id="statusBadge" style="display:none">
        <span id="recordCount">0</span> Records Loaded
      </span>
    </div>
  </header>

  <!-- Error Alert -->
  <div class="alert" id="errorAlert">
    <div class="alert-header">
      <span class="alert-icon">‚ö†Ô∏è</span>
      <h3 class="alert-title">Data Loading Failed</h3>
    </div>
    <div class="alert-body" id="errorMessage">
      Could not load mc_data.csv. Please check if the file exists in the same directory as this HTML file.
    </div>
    <div class="alert-actions">
      <button class="btn btn-primary" onclick="document.getElementById('csvFileInput').click()">
        üìÅ Upload CSV File
      </button>
      <button class="btn btn-secondary" onclick="location.reload()">
        üîÑ Retry
      </button>
    </div>
  </div>

  <!-- File Upload Area -->
  <div class="upload-area" id="uploadArea" onclick="document.getElementById('csvFileInput').click()">
    <div class="upload-icon">üìä</div>
    <div class="upload-title">Upload CSV File</div>
    <div class="upload-text">Click to browse or drag and drop your mc_data.csv file here</div>
    <button class="btn btn-primary" style="pointer-events:none">Choose File</button>
  </div>
  <input type="file" id="csvFileInput" accept=".csv" />

  <main class="main" id="mainContent">
    <!-- KPIs -->
    <div class="kpis">
      <div class="kpi">
        <div class="kpi-icon">üìû</div>
        <div class="kpi-label">Total Missed Calls</div>
        <div class="kpi-value" id="totalGrowers">0</div>
        <div class="kpi-subtext">All records in dataset</div>
      </div>
      <div class="kpi">
        <div class="kpi-icon">üë•</div>
        <div class="kpi-label">Unique Growers</div>
        <div class="kpi-value" id="uniqueGrowers">0</div>
        <div class="kpi-subtext">Distinct grower contacts</div>
      </div>
      <div class="kpi">
        <div class="kpi-icon">üéØ</div>
        <div class="kpi-label">Active PTs</div>
        <div class="kpi-value" id="activePTs">0 / 253</div>
        <div class="kpi-subtext">Personnel territories</div>
      </div>
    </div>

    <!-- Filters -->
    <div class="filters-section">
      <div class="filters-header">
        <h2 class="filters-title">
          <span>üîç</span>
          Filters & Export
        </h2>
        <button class="btn btn-success" id="downloadBtn">
          <span>üì•</span> Download Excel
        </button>
      </div>
      
      <div class="filters-grid">
        <div class="filter-group">
          <label>
            <span>üì± Digitrack No</span>
            <span class="filter-count" id="digitrackCount">0</span>
          </label>
          <select id="filterDigitrack">
            <option value="">All Digitrack Numbers</option>
          </select>
        </div>
        <div class="filter-group">
          <label>
            <span>üó∫Ô∏è State</span>
            <span class="filter-count" id="stateCount">0</span>
          </label>
          <select id="filterState">
            <option value="">All States</option>
          </select>
        </div>
        <div class="filter-group">
          <label>
            <span>üè¢ HQ</span>
            <span class="filter-count" id="hqCount">0</span>
          </label>
          <select id="filterHQ">
            <option value="">All HQs</option>
          </select>
        </div>
        <div class="filter-group">
          <label>
            <span>üìç District</span>
            <span class="filter-count" id="districtCount">0</span>
          </label>
          <select id="filterDistrict">
            <option value="">All Districts</option>
          </select>
        </div>
        <div class="filter-group">
          <label>
            <span>üåê Zone</span>
            <span class="filter-count" id="zoneCount">0</span>
          </label>
          <select id="filterZone">
            <option value="">All Zones</option>
          </select>
        </div>
        <div class="filter-group">
          <label>
            <span>üë§ Name (PT)</span>
            <span class="filter-count" id="nameCount">0</span>
          </label>
          <select id="filterName">
            <option value="">All PTs</option>
          </select>
        </div>
        <div class="filter-group">
          <label>üìÖ Date Range</label>
          <input type="text" id="filterDateRange" placeholder="Select date range..." readonly>
        </div>
      </div>
      
      <div class="filter-actions">
        <button class="btn btn-secondary" id="resetFiltersBtn">
          <span>üîÑ</span> Reset Filters
        </button>
      </div>
    </div>

    <!-- Universal Search -->
    <div class="search-section">
      <div class="search-box">
        <span class="search-icon">üîç</span>
        <input 
          type="text" 
          class="search-input" 
          id="universalSearch" 
          placeholder="Search across all columns (name, mobile, grower, etc.)..."
        >
        <span class="search-count" id="searchCount"></span>
      </div>
    </div>

    <!-- Charts -->
    <div class="charts-grid">
      <div class="chart-card">
        <h3 class="chart-title">
          <span>üìç</span>
          Top 10 States by Missed Calls
        </h3>
        <div class="chart-container">
          <canvas id="stateChart"></canvas>
        </div>
      </div>
      <div class="chart-card">
        <h3 class="chart-title">
          <span>üë§</span>
          Top 10 PTs by Missed Calls
        </h3>
        <div class="chart-container">
          <canvas id="ptChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Data Table -->
    <div class="table-section">
      <div class="table-header">
        <h2 class="table-title">üìã Missed Call Records</h2>
        <span class="table-info" id="tableInfo">Showing 0 of 0 records</span>
      </div>
      
      <div class="table-container">
        <table id="dataTable">
          <thead>
            <tr>
              <th>Digitrack No</th>
              <th>Grower</th>
              <th>Date</th>
              <th>Action</th>
              <th>Date Processed</th>
              <th>Name (PT)</th>
              <th>HQ</th>
              <th>District</th>
              <th>Zone</th>
              <th>State</th>
              <th>Mobile</th>
              <th>Language</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <tr><td colspan="12" style="text-align:center;padding:40px">No data available</td></tr>
          </tbody>
        </table>
      </div>
      
      <div class="pagination" id="pagination"></div>
    </div>
  </main>

  <script>
    // ========================
    // STATE MANAGEMENT
    // ========================
    let MC_DATA = [];
    let FILTERED_DATA = [];
    let CURRENT_PAGE = 1;
    const ROWS_PER_PAGE = 50;
    let stateChart = null;
    let ptChart = null;

    // ========================
    // DATA LOADING
    // ========================
    
    // Try to load CSV from file path
    function loadCSV() {
      console.log('üîÑ Attempting to load mc_data.csv...');
      
      Papa.parse('./mc_data.csv', {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: handleCSVSuccess,
        error: handleCSVError
      });
    }

    // Handle file upload
    document.getElementById('csvFileInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      console.log('üìÅ File selected:', file.name);
      document.getElementById('loadingOverlay').classList.remove('hidden');
      document.getElementById('errorAlert').classList.remove('show');
      document.getElementById('uploadArea').classList.remove('show');
      
      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: handleCSVSuccess,
        error: handleCSVError
      });
    });

    // Success handler
    function handleCSVSuccess(result) {
      console.log('‚úÖ CSV loaded successfully!', result.data.length, 'records');
      
      MC_DATA = result.data.filter(row => {
        // Filter out empty rows
        return Object.values(row).some(val => val && val.trim() !== '');
      });
      
      if (MC_DATA.length === 0) {
        handleCSVError({ message: 'CSV file is empty or has no valid data' });
        return;
      }
      
      FILTERED_DATA = [...MC_DATA];
      
      // Hide loading, show content
      setTimeout(() => {
        document.getElementById('loadingOverlay').classList.add('hidden');
        document.getElementById('mainContent').classList.add('show');
        document.getElementById('statusBadge').style.display = 'inline-flex';
        document.getElementById('recordCount').textContent = MC_DATA.length.toLocaleString();
        
        // Initialize
        populateFilters();
        initializeDatePicker();
        attachEventHandlers();
        render();
        
        console.log('üéâ Dashboard initialized successfully!');
      }, 500);
    }

    // Error handler
    function handleCSVError(error) {
      console.error('‚ùå Error loading CSV:', error);
      
      document.getElementById('loadingOverlay').classList.add('hidden');
      document.getElementById('errorAlert').classList.add('show');
      document.getElementById('uploadArea').classList.add('show');
      
      const errorMsg = error.message || 'Unknown error occurred';
      document.getElementById('errorMessage').innerHTML = `
        <strong>Error:</strong> ${errorMsg}<br><br>
        <strong>Troubleshooting:</strong><br>
        ‚Ä¢ Make sure mc_data.csv is in the same folder as this HTML file<br>
        ‚Ä¢ Check that the CSV file is properly formatted<br>
        ‚Ä¢ Try uploading the file manually using the button below
      `;
    }

    // ========================
    // FILTER POPULATION
    // ========================
    
    function populateFilters(preserveFilters = false) {
      const currentFilters = preserveFilters ? {
        digitrack: document.getElementById('filterDigitrack').value,
        state: document.getElementById('filterState').value,
        hq: document.getElementById('filterHQ').value,
        district: document.getElementById('filterDistrict').value,
        zone: document.getElementById('filterZone').value,
        name: document.getElementById('filterName').value
      } : {};

      let baseData = [...MC_DATA];
      
      // Apply date filter to base data
      if (window.dateRangePicker && window.dateRangePicker.selectedDates.length === 2) {
        const dates = window.dateRangePicker.selectedDates;
        const dateFrom = formatDateYYYYMMDD(dates[0]);
        const dateTo = formatDateYYYYMMDD(dates[1]);
        
        baseData = baseData.filter(row => {
          const rowDate = parseDateProcessed(row['Date Processed']) || parseDate(row['Date']);
          if (!rowDate) return false;
          return rowDate >= dateFrom && rowDate <= dateTo;
        });
      }

      // Build cascading filter options
      const digitrackData = filterByOthers(baseData, currentFilters, 'digitrack');
      const digitracks = getUniqueValues(digitrackData, 'Digitrack No');
      
      const stateData = filterByOthers(baseData, currentFilters, 'state');
      const states = getUniqueValues(stateData, 'State');
      
      const hqData = filterByOthers(baseData, currentFilters, 'hq');
      const hqs = getUniqueValues(hqData, 'HQ');
      
      const districtData = filterByOthers(baseData, currentFilters, 'district');
      const districts = getUniqueValues(districtData, 'Division/PT District');
      
      const zoneData = filterByOthers(baseData, currentFilters, 'zone');
      const zones = getUniqueValues(zoneData, 'ZONE');
      
      const nameData = filterByOthers(baseData, currentFilters, 'name');
      const names = getUniqueValues(nameData, 'Name');
      
      populateSelect('filterDigitrack', digitracks, preserveFilters ? currentFilters.digitrack : '', 'digitrackCount');
      populateSelect('filterState', states, preserveFilters ? currentFilters.state : '', 'stateCount');
      populateSelect('filterHQ', hqs, preserveFilters ? currentFilters.hq : '', 'hqCount');
      populateSelect('filterDistrict', districts, preserveFilters ? currentFilters.district : '', 'districtCount');
      populateSelect('filterZone', zones, preserveFilters ? currentFilters.zone : '', 'zoneCount');
      populateSelect('filterName', names, preserveFilters ? currentFilters.name : '', 'nameCount');
    }

    function filterByOthers(data, filters, exclude) {
      let result = data;
      if (exclude !== 'digitrack' && filters.digitrack) {
        result = result.filter(r => r['Digitrack No'] === filters.digitrack);
      }
      if (exclude !== 'state' && filters.state) {
        result = result.filter(r => r.State === filters.state);
      }
      if (exclude !== 'hq' && filters.hq) {
        result = result.filter(r => r.HQ === filters.hq);
      }
      if (exclude !== 'district' && filters.district) {
        result = result.filter(r => r['Division/PT District'] === filters.district);
      }
      if (exclude !== 'zone' && filters.zone) {
        result = result.filter(r => r.ZONE === filters.zone);
      }
      if (exclude !== 'name' && filters.name) {
        result = result.filter(r => r.Name === filters.name);
      }
      return result;
    }

    function getUniqueValues(data, field) {
      return [...new Set(data.map(r => r[field]).filter(Boolean))].sort();
    }

    function populateSelect(id, options, valueToSet, countId) {
      const select = document.getElementById(id);
      const labels = {
        'filterDigitrack': 'All Digitrack Numbers',
        'filterState': 'All States',
        'filterHQ': 'All HQs',
        'filterDistrict': 'All Districts',
        'filterZone': 'All Zones',
        'filterName': 'All PTs'
      };
      
      select.innerHTML = `<option value="">${labels[id]}</option>`;
      options.forEach(opt => {
        const option = document.createElement('option');
        option.value = opt;
        option.textContent = opt;
        select.appendChild(option);
      });
      
      if (countId) {
        document.getElementById(countId).textContent = options.length;
      }
      
      if (valueToSet && options.includes(valueToSet)) {
        select.value = valueToSet;
      }
    }

    // ========================
    // FILTERING
    // ========================
    
    function applyFilters() {
      const digitrack = document.getElementById('filterDigitrack').value;
      const state = document.getElementById('filterState').value;
      const hq = document.getElementById('filterHQ').value;
      const district = document.getElementById('filterDistrict').value;
      const zone = document.getElementById('filterZone').value;
      const name = document.getElementById('filterName').value;
      const searchQuery = document.getElementById('universalSearch').value.toLowerCase().trim();
      
      let dateFrom = null;
      let dateTo = null;
      if (window.dateRangePicker && window.dateRangePicker.selectedDates.length === 2) {
        const dates = window.dateRangePicker.selectedDates;
        dateFrom = formatDateYYYYMMDD(dates[0]);
        dateTo = formatDateYYYYMMDD(dates[1]);
      }

      FILTERED_DATA = MC_DATA.filter(row => {
        if (digitrack && row['Digitrack No'] !== digitrack) return false;
        if (state && row.State !== state) return false;
        if (hq && row.HQ !== hq) return false;
        if (district && row['Division/PT District'] !== district) return false;
        if (zone && row.ZONE !== zone) return false;
        if (name && row.Name !== name) return false;
        
        if (dateFrom && dateTo) {
          const rowDate = parseDateProcessed(row['Date Processed']) || parseDate(row['Date']);
          if (!rowDate || rowDate < dateFrom || rowDate > dateTo) return false;
        }
        
        if (searchQuery) {
          return Object.values(row).some(val => 
            String(val).toLowerCase().includes(searchQuery)
          );
        }
        
        return true;
      });

      CURRENT_PAGE = 1;
      populateFilters(true);
      render();
      
      // Update search count
      const searchCount = document.getElementById('searchCount');
      if (searchQuery) {
        searchCount.textContent = `${FILTERED_DATA.length} results`;
      } else {
        searchCount.textContent = '';
      }
    }

    function resetFilters() {
      document.getElementById('filterDigitrack').value = '';
      document.getElementById('filterState').value = '';
      document.getElementById('filterHQ').value = '';
      document.getElementById('filterDistrict').value = '';
      document.getElementById('filterZone').value = '';
      document.getElementById('filterName').value = '';
      document.getElementById('filterDateRange').value = '';
      document.getElementById('universalSearch').value = '';
      document.getElementById('searchCount').textContent = '';
      
      if (window.dateRangePicker) {
        window.dateRangePicker.clear();
      }
      
      FILTERED_DATA = [...MC_DATA];
      CURRENT_PAGE = 1;
      
      populateFilters(false);
      render();
    }

    // ========================
    // SEARCH
    // ========================
    
    let searchTimeout;
    function universalSearch() {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        applyFilters();
      }, 300);
    }

    // ========================
    // DATE UTILITIES
    // ========================
    
    function formatDateYYYYMMDD(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function parseDateProcessed(dateStr) {
      if (!dateStr) return null;
      const parts = dateStr.trim().split('-');
      if (parts.length !== 3) return null;
      
      const day = parts[0].padStart(2, '0');
      const monthStr = parts[1];
      const year = parts[2].length === 2 ? '20' + parts[2] : parts[2];
      
      const monthMap = {
        'Jan': '01', 'Feb': '02', 'Mar': '03', 'Apr': '04',
        'May': '05', 'Jun': '06', 'Jul': '07', 'Aug': '08',
        'Sep': '09', 'Oct': '10', 'Nov': '11', 'Dec': '12'
      };
      
      const month = monthMap[monthStr];
      if (!month) return null;
      
      return `${year}-${month}-${day}`;
    }

    function parseDate(dateStr) {
      if (!dateStr) return null;
      const datePart = dateStr.trim().split(' ')[0];
      const parts = datePart.split('-');
      
      if (parts.length !== 3) return null;
      
      const day = parts[0].padStart(2, '0');
      const month = parts[1].padStart(2, '0');
      const year = parts[2];
      
      return `${year}-${month}-${day}`;
    }

    // ========================
    // RENDERING
    // ========================
    
    function render() {
      updateKPIs();
      renderCharts();
      renderTable();
      renderPagination();
    }

    function updateKPIs() {
      const totalGrowers = FILTERED_DATA.length;
      const uniqueGrowers = new Set(FILTERED_DATA.map(r => r.Grower).filter(Boolean)).size;
      const activePTs = new Set(FILTERED_DATA.map(r => r.Name).filter(Boolean)).size;
      
      document.getElementById('totalGrowers').textContent = totalGrowers.toLocaleString();
      document.getElementById('uniqueGrowers').textContent = uniqueGrowers.toLocaleString();
      document.getElementById('activePTs').textContent = `${activePTs} / 253`;
    }

    function renderCharts() {
      // State-wise data
      const stateData = {};
      FILTERED_DATA.forEach(row => {
        const state = row.State || 'Unknown';
        stateData[state] = (stateData[state] || 0) + 1;
      });
      
      const states = Object.keys(stateData).sort((a,b) => stateData[b] - stateData[a]).slice(0,10);
      const stateCounts = states.map(s => stateData[s]);

      // PT-wise data
      const ptData = {};
      FILTERED_DATA.forEach(row => {
        const pt = row.Name || 'Unknown';
        ptData[pt] = (ptData[pt] || 0) + 1;
      });
      
      const pts = Object.keys(ptData).sort((a,b) => ptData[b] - ptData[a]).slice(0,10);
      const ptCounts = pts.map(p => ptData[p]);

      // Render State Chart
      const stateCtx = document.getElementById('stateChart').getContext('2d');
      if (stateChart) stateChart.destroy();
      stateChart = new Chart(stateCtx, {
        type: 'bar',
        data: {
          labels: states,
          datasets: [{
            label: 'Missed Calls',
            data: stateCounts,
            backgroundColor: 'rgba(99, 102, 241, 0.8)',
            borderColor: 'rgba(99, 102, 241, 1)',
            borderWidth: 2,
            borderRadius: 8,
            hoverBackgroundColor: 'rgba(99, 102, 241, 1)'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              padding: 12,
              titleFont: { size: 14, weight: 'bold' },
              bodyFont: { size: 13 }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { 
                font: { weight: '600' },
                padding: 8
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              }
            },
            x: {
              ticks: { 
                font: { weight: '600' },
                padding: 8
              },
              grid: {
                display: false
              }
            }
          }
        }
      });

      // Render PT Chart
      const ptCtx = document.getElementById('ptChart').getContext('2d');
      if (ptChart) ptChart.destroy();
      ptChart = new Chart(ptCtx, {
        type: 'bar',
        data: {
          labels: pts,
          datasets: [{
            label: 'Missed Calls',
            data: ptCounts,
            backgroundColor: 'rgba(16, 185, 129, 0.8)',
            borderColor: 'rgba(16, 185, 129, 1)',
            borderWidth: 2,
            borderRadius: 8,
            hoverBackgroundColor: 'rgba(16, 185, 129, 1)'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              padding: 12,
              titleFont: { size: 14, weight: 'bold' },
              bodyFont: { size: 13 }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { 
                font: { weight: '600' },
                padding: 8
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              }
            },
            x: {
              ticks: {
                font: { weight: '600' },
                maxRotation: 45,
                minRotation: 45,
                padding: 8
              },
              grid: {
                display: false
              }
            }
          }
        }
      });
    }

    function renderTable() {
      const start = (CURRENT_PAGE - 1) * ROWS_PER_PAGE;
      const end = start + ROWS_PER_PAGE;
      const pageData = FILTERED_DATA.slice(start, end);

      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = '';

      if (pageData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="12" style="text-align:center;padding:60px;color:#9ca3af;font-size:16px">üì≠ No data found matching your filters</td></tr>';
      } else {
        pageData.forEach(row => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${row['Digitrack No'] || '-'}</td>
            <td>${row.Grower || '-'}</td>
            <td>${row.Date || '-'}</td>
            <td>${row.Action || '-'}</td>
            <td>${row['Date Processed'] || '-'}</td>
            <td>${row.Name || '-'}</td>
            <td>${row.HQ || '-'}</td>
            <td>${row['Division/PT District'] || '-'}</td>
            <td>${row.ZONE || '-'}</td>
            <td>${row.State || '-'}</td>
            <td>${row['Mobile number'] || '-'}</td>
            <td>${row.Language || '-'}</td>
          `;
          tbody.appendChild(tr);
        });
      }

      document.getElementById('tableInfo').textContent = 
        `Showing ${start + 1}-${Math.min(end, FILTERED_DATA.length)} of ${FILTERED_DATA.length.toLocaleString()} records`;
    }

    function renderPagination() {
      const totalPages = Math.ceil(FILTERED_DATA.length / ROWS_PER_PAGE);
      const pagination = document.getElementById('pagination');
      pagination.innerHTML = '';

      if (totalPages <= 1) return;

      // Previous
      const prev = document.createElement('button');
      prev.textContent = '‚Üê Previous';
      prev.className = 'page-btn';
      prev.disabled = CURRENT_PAGE === 1;
      prev.onclick = () => {
        if (CURRENT_PAGE > 1) {
          CURRENT_PAGE--;
          renderTable();
          renderPagination();
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
      };
      pagination.appendChild(prev);

      // Page numbers
      const maxPages = 5;
      let startPage = Math.max(1, CURRENT_PAGE - Math.floor(maxPages / 2));
      let endPage = Math.min(totalPages, startPage + maxPages - 1);

      if (endPage - startPage < maxPages - 1) {
        startPage = Math.max(1, endPage - maxPages + 1);
      }

      if (startPage > 1) {
        const first = document.createElement('button');
        first.textContent = '1';
        first.className = 'page-btn';
        first.onclick = () => {
          CURRENT_PAGE = 1;
          renderTable();
          renderPagination();
          window.scrollTo({ top: 0, behavior: 'smooth' });
        };
        pagination.appendChild(first);

        if (startPage > 2) {
          const dots = document.createElement('span');
          dots.textContent = '...';
          dots.style.padding = '0 8px';
          dots.style.color = '#9ca3af';
          pagination.appendChild(dots);
        }
      }

      for (let i = startPage; i <= endPage; i++) {
        const btn = document.createElement('button');
        btn.textContent = i;
        btn.className = 'page-btn' + (i === CURRENT_PAGE ? ' active' : '');
        btn.onclick = () => {
          CURRENT_PAGE = i;
          renderTable();
          renderPagination();
          window.scrollTo({ top: 0, behavior: 'smooth' });
        };
        pagination.appendChild(btn);
      }

      if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
          const dots = document.createElement('span');
          dots.textContent = '...';
          dots.style.padding = '0 8px';
          dots.style.color = '#9ca3af';
          pagination.appendChild(dots);
        }

        const last = document.createElement('button');
        last.textContent = totalPages;
        last.className = 'page-btn';
        last.onclick = () => {
          CURRENT_PAGE = totalPages;
          renderTable();
          renderPagination();
          window.scrollTo({ top: 0, behavior: 'smooth' });
        };
        pagination.appendChild(last);
      }

      // Next
      const next = document.createElement('button');
      next.textContent = 'Next ‚Üí';
      next.className = 'page-btn';
      next.disabled = CURRENT_PAGE === totalPages;
      next.onclick = () => {
        if (CURRENT_PAGE < totalPages) {
          CURRENT_PAGE++;
          renderTable();
          renderPagination();
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
      };
      pagination.appendChild(next);
    }

    // ========================
    // EXCEL EXPORT
    // ========================
    
    function downloadExcel() {
      const dataToExport = FILTERED_DATA.length > 0 ? FILTERED_DATA : MC_DATA;
      
      const ws = XLSX.utils.json_to_sheet(dataToExport);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Missed Calls');
      
      const filename = `missed_calls_${new Date().toISOString().slice(0,10)}.xlsx`;
      XLSX.writeFile(wb, filename);
      
      // Show success message
      const btn = document.getElementById('downloadBtn');
      const originalHTML = btn.innerHTML;
      btn.innerHTML = '<span>‚úÖ</span> Downloaded!';
      btn.style.background = 'linear-gradient(135deg, var(--success), #059669)';
      
      setTimeout(() => {
        btn.innerHTML = originalHTML;
        btn.style.background = '';
      }, 2000);
    }

    // ========================
    // INITIALIZATION
    // ========================
    
    function initializeDatePicker() {
      window.dateRangePicker = flatpickr("#filterDateRange", {
        mode: "range",
        dateFormat: "Y-m-d",
        maxDate: "today",
        onChange: function(selectedDates) {
          if (selectedDates.length === 2) {
            applyFilters();
          }
        },
        onClose: function(selectedDates) {
          if (selectedDates.length === 2) {
            applyFilters();
          }
        }
      });
    }

    function attachEventHandlers() {
      document.getElementById('filterDigitrack').onchange = applyFilters;
      document.getElementById('filterState').onchange = applyFilters;
      document.getElementById('filterHQ').onchange = applyFilters;
      document.getElementById('filterDistrict').onchange = applyFilters;
      document.getElementById('filterZone').onchange = applyFilters;
      document.getElementById('filterName').onchange = applyFilters;
      document.getElementById('universalSearch').oninput = universalSearch;
      document.getElementById('resetFiltersBtn').onclick = resetFilters;
      document.getElementById('downloadBtn').onclick = downloadExcel;
    }

    // ========================
    // START APPLICATION
    // ========================
    
    // Start loading CSV on page load
    window.addEventListener('DOMContentLoaded', () => {
      console.log('üöÄ Application starting...');
      loadCSV();
    });
  </script>
</body>
</html>
